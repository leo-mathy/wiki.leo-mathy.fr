---
title: Exploitation Capcom
description: Exploiter le privilège SeLoadDriverPrivilege pour charger le driver Capcom.sys et exécuter du code avec les privilèges SYSTEM
published: true
date: 2024-07-19T11:57:08.829Z
tags: outil, windows
editor: markdown
dateCreated: 2024-07-19T11:04:55.005Z
---

# Introduction

Exploiter le privilège SeLoadDriverPrivilege pour charger le driver Capcom.sys et exécuter du code avec les privilèges SYSTEM.

> Depuis Windows 10 Version 1803, le privilège SeLoadDriverPrivilege n'est plus exploitable, depuis qu'il n'est plus possible d'inclure des references aux clés de registre depuis HKEY_CURRENT_USER (HKCU)
> {.is-danger}

# Méthode manuelle

## Enregistrer le driver dans le registre

Enregistrer le driver capcom.sys sur la cible depuis https://github.com/FuzzySecurity/Capcom-Rootkit

Créer une nouvelle clé dans le registre à l'emplacement **HKCU\System\CurrentControlSet\CAPCOM**. Dans cette clé ajouter une entrée de type **REG_SZ** (chaine) nommé **ImagePath** avec comme valeur l'emplacement du driver **Capcom.sys**.

`reg add HKCU\System\CurrentControlSet\CAPCOM /v ImagePath /t REG_SZ /d "\??\[volume]:\[chemin du fichier Capcom.sys]"`.

> Le début du chemin `\??\` indique que la valeur fait référence à un objet NT (voir https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-even/c1550f98-a1ce-426a-9991-7509e7c3787c)
> {.is-info}

Ajouter une entrée dans la clé **HKCU\System\CurrentControlSet\CAPCOM** de type **REG_DWORD** nommé **Type** avec comme valeur **1**.

`reg add HKCU\System\CurrentControlSet\CAPCOM /v Type /t REG_DWORD /d 1`

## Introduction EnableSeLoadDriverPrivilege

Une fois le driver Capcom.sys spécifié dans le registre, il est possible d'activer le privilège SeLoadDriverPrivilege dans le processus en cours et de charger le driver Capcom.sys dans le kernel.

> EnableSeLoadDriverPrivilege est disponible ici: https://github.com/3gstudent/Homework-of-C-Language/blob/master/EnableSeLoadDriverPrivilege.cpp
> {.is-info}

> Il ne faut pas oublier que le code source C++ doit être compilé
> {.is-warning}

> Il est possible d'utiliser la commande [driverquery](/Commandes/Windows/driverquery) pour voir si le driver est chargé ou non.
> {.is-info}

## Syntaxe EnableSeLoadDriverPrivilege

`EnableSeLoadDriverPrivilege.exe`

# Méthode Automatique

Il est possible d'utiliser EoPLoadDriver pour activer le privilège SeLoadDriverPrivilege dans le processus, créer les clés dans le registre et charger le driver avec la fonction SeLoadDriverPrivilege.

> Voir [EoPLoadDriver](/Outils/Windows/EoPLoadDriver)
> {.is-info}

# Exploitation

## Introduction ExploitCapcom

ExploitCapcom permet de lancer des commandes en utilisant le driver Capcom et la fonctionnalité de voler le token pour avoir accès au privileges SYSTEM.

> ExploitCapcom est disponible ici: https://github.com/tandasat/ExploitCapcom
> {.is-info}

> Il ne faut pas oublier que le code source C++ doit être compilé
> {.is-warning}

## Modification d'exécution d'ExploitCapcom

Par défaut, ExploitCapcom.exe lance une console avec les privilèges SYSTEM. Il est possible de changer cela avant la compilation en modifiant la ligne 410 https://github.com/tandasat/ExploitCapcom/blob/master/ExploitCapcom/ExploitCapcom/ExploitCapcom.cpp#L410

`TCHAR CommandLine[] = TEXT("[Commande]");`

## Syntaxe ExploitCapcom

`ExploitCapcom.exe`
